name: CD - Local Swarm Deployment

on:
  workflow_run:
    workflows: ["CI - Build & Push (Docker Hub)"]
    types: [completed]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Tag Docker (ex: latest, sha-<short>, <full_sha>). Vide = auto SHA court"
        required: false
        default: ""

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: [self-hosted, swarm-manager]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with: { clean: true }

      - name: Calculate short SHA
        id: sha
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            SHA_SOURCE="${{ github.event.workflow_run.head_sha }}"
          else
            SHA_SOURCE="${{ github.sha }}"
          fi
          SHORT_SHA="${SHA_SOURCE:0:7}"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Determine image tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          MANUAL_TAG="${{ github.event.inputs.image_tag }}"
          if [[ -n "${MANUAL_TAG}" ]]; then
            FINAL_TAG="${MANUAL_TAG}"
          else
            FINAL_TAG="sha-${{ steps.sha.outputs.short_sha }}"
          fi

          # Optionnel : v√©rifier que le tag existe sur Docker Hub, sinon fallback `latest`
          USER="${{ secrets.DOCKERHUB_USERNAME }}"
          IMAGE="lab-app"
          if ! docker manifest inspect "${USER}/${IMAGE}:${FINAL_TAG}" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag ${FINAL_TAG} introuvable sur Docker Hub ‚Äî fallback sur 'latest'"
            FINAL_TAG="latest"
          fi

          echo "image_tag=${FINAL_TAG}" >> "$GITHUB_OUTPUT"

      - name: Login to Docker Hub
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # üîê Pr√©parer les certificats pour Traefik (√† partir des secrets GitHub)
      - name: Prepare certs for Traefik
        shell: bash
        run: |
          set -euo pipefail

          CERTS_DIR="$HOME/traefik/certs"
          mkdir -p "$CERTS_DIR"

          # LOCAL_CERT = cert complet (BEGIN CERTIFICATE ... END CERTIFICATE)
          # LOCAL_KEY  = cl√© priv√©e compl√®te (BEGIN PRIVATE KEY ... END PRIVATE KEY)
          printf '%s' "${{ secrets.LOCAL_CERT }}" > "$CERTS_DIR/local-cert.pem"
          printf '%s' "${{ secrets.LOCAL_KEY }}"  > "$CERTS_DIR/local-key.pem"

          echo "TRAEFIK_CERTS_DIR=$CERTS_DIR" >> "$GITHUB_ENV"

          ls -l "$CERTS_DIR"

      # üìÇ Pointer vers la config dynamique Traefik (tls.yml) versionn√©e dans le repo
      - name: Export dynamic config path
        shell: bash
        run: |
          set -euo pipefail
          echo "TRAEFIK_DYNAMIC_DIR=${GITHUB_WORKSPACE}/traefik/dynamic" >> "$GITHUB_ENV"


      - name: Generate stack file
        shell: bash
        run: |
          set -euo pipefail
          sed -e "s|DOCKERHUB_USERNAME|${{ secrets.DOCKERHUB_USERNAME }}|g" \
              -e "s|IMAGE_TAG|${{ steps.tag.outputs.image_tag }}|g" \
              docker-stack.traefik_external_https.yml > /tmp/stack.yml
          head -n 30 /tmp/stack.yml
      
      - name: Initialize Swarm & ensure traefik network
        shell: bash
        run: |
          set -euo pipefail
          docker swarm leave --force || true
          docker swarm init --advertise-addr 192.168.1.10
          docker network rm traefik 2>/dev/null || true
          docker network create --driver=overlay traefik
          
          #TODO : tests
          ## Activer Swarm si besoin
          #if ! docker info --format '{{.Swarm.LocalNodeState}}' | grep -q "active"; then
          #  docker swarm init --advertise-addr 192.168.1.10
          #fi

          ## Cr√©er le r√©seau overlay "traefik" s'il n'existe pas d√©j√†
          #if ! docker network ls --format '{{.Name}}' | grep -qx 'traefik'; then
          #  docker network create --driver=overlay traefik
          #fi

      - name: Deploy stack
        shell: bash
        run: |
          set -euo pipefail
          docker stack deploy -c /tmp/stack.yml lab --with-registry-auth
          docker stack services lab
